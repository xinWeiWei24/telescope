parameters:
  - name: desired_nodes
    type: number
  - name: operation_timeout
    type: number
    default: 10
  - name: enable_karpenter
    type: boolean
  - name: cloud
    type: string

steps:
  - script: |
      set -eo pipefail

      PYTHONPATH=$PYTHONPATH:$(pwd) python3 $PYTHON_SCRIPT_FILE validate $DESIRED_NODES $OPERATION_TIMEOUT
    workingDirectory: modules/python/clusterloader2
    timeoutInMinutes: ${{ parameters.operation_timeout }}
    displayName: "Validate node count"
    env:
      DESIRED_NODES: ${{ parameters.desired_nodes }}
      OPERATION_TIMEOUT: ${{ parameters.operation_timeout }}
      PYTHON_SCRIPT_FILE: $(Pipeline.Workspace)/s/modules/python/clusterloader2/slo/slo.py
  - ${{ if eq(parameters.enable_karpenter, true) }}:
      - script: kubectl apply -f $KARPENTER_NODEPOOL_FILE
        env:
          CLOUD: ${{ parameters.cloud }}
          KARPENTER_NODEPOOL_FILE: $(Pipeline.Workspace)/s/scenarios/$(SCENARIO_TYPE)/$(SCENARIO_NAME)/kubernetes/karpenter_nodepool.${{ parameters.cloud }}.yml
        displayName: "Validate Karpenter setup"
